#!/bin/zsh

source ${0:a:h}/setup-dev-shell

ensure_in_project_root

full_reset() {
        source ./.env
        PGPASSWORD=$DB_PASSWORD psql -h localhost -U postgres << EOF
        DROP DATABASE ${DB_NAME};
        CREATE DATABASE ${DB_NAME}
EOF

        dev makemigrations
        dev migrate

        make import.orion
        make mark.indistrict

}

case $1 in
    db)
        PGPASSWORD=postgres psql -h localhost -U postgres
        ;;

    db.dev)
        PGPASSWORD=postgres psql -h localhost -U postgres ditchdb_dev
        ;;
        
    db.e2e)
        PGPASSWORD=postgres psql -h localhost -U postgres ditchdb_e2e
        ;;

    db.test)
        PGPASSWORD=postgres psql -h localhost -U postgres ditchdb_test
        ;;

    full.reset)
        full_reset
        ;;

    manage)
        zsh -c "$DOCKER_EXEC_DEV zsh -c 'cd backend && python manage.py $2'"
        ;;

    pysh)
        zsh -c "$DOCKER_EXEC_DEV zsh -c 'cd backend && python manage.py shell'"
        ;;

    term)
        zsh -c "$DOCKER_EXEC_DEV zsh"
        ;;

    *)
        zsh -c "$DOCKER_EXEC_DEV make $1"
        ;;
esac

