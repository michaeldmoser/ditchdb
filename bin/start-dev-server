#!/bin/bash

trap shutdown_dev EXIT 
trap shutdown_dev HUP
trap shutdown_dev QUIT

DJANGO_RUN_PORT=${DJANGO_PORT:-8000}
VITE_DEV_PORT=${VITE_DEV_PORT:-5173}

BIN_DIR=$(dirname `readlink -f "${BASH_SOURCE:-$0}"`)
PROJECT_DIR="${BIN_DIR}/../"
DJANGO_ENV=${DJANGO_ENV:-${PROJECT_DIR}/.env}

cd $PROJECT_DIR/frontend &> /dev/null
VITE_DEV_PORT=${VITE_DEV_PORT} npm run dev &
FRONTEND_PID=$!

cd $PROJECT_DIR/backend

DJANGO_ENV=$DJANGO_ENV python ./manage.py runserver 0.0.0.0:$DJANGO_RUN_PORT &
BACKEND_PID=$!

shutdown_dev() {
  kill $BACKEND_PID
  kill $FRONTEND_PID
}

wait $BACKEND_PID
wait $FRONTEND_PID
